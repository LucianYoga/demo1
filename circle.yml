machine:
    ruby:
      version: 2.1.3
    services:
      - docker
    environment:
      SHORT_SHA: $(echo $CIRCLE_SHA1 | cut -b1-7)
      TAG_NAME: “br-$CIRCLE_BRANCH-$SHORT_SHA”
      IMAGE_PATH: “lucianyoga01/demo1”
      DOCKER_RUN_CMD: “elixir -pa _build/prod/consilidated -S mix test”
      PROD: carburetor-prod-s1
      STAG: carburetor-stag-s1

  dependencies:
    pre:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker build -t $IMAGE_PATH:$TAG_NAME .

  test:
    override:
      - docker run -tip 3000:3000 bleacher/carburetor:$TAG_NAME $DOCKER_RUN_CMD

  deployment:
    production:
      branch: release
      commands:
        - gem install gantree
        - docker push $IMAGE_PATH:$TAG_NAME
        - gantree deploy $PROD -i $IMAGE_PATH -t $TAG_NAME
    staging:
      branch: continuous-deployment
      commands:
        - gem install gantree
        - docker push $IMAGE_PATH:$TAG_NAME
        - gantree deploy $STAG -i $IMAGE_PATH -t $TAG_NAME
